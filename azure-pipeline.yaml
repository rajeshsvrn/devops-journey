trigger:
  branches:
    include:
      - develop
      - qa
      - main

variables:
  azureServiceConnection: "azure-federated-identity"
  containerRegistry: "devopsjourney.azurecr.io"
  gitOpsRepoUrl: "https://github.com/rajeshsvrn/devops-journey.git"

  targetEnvironment: ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/qa') }} then 'qa' else 'development'
  namespace: ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/qa') }} then 'qa' else 'develop'
  imageTag: ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/qa') }} then 'qa-$(Build.BuildNumber)' else 'dev-$(Build.BuildNumber)'

stages:
  - stage: Test_GitOps_Simple
    displayName: "Simple GitOps Test"
    jobs:
      - job: TestGitOps
        displayName: "Test GitOps Workflow"
        pool:
          name: "devopsjourney"
        steps:
          - task: AzureCLI@2
            displayName: "Test Azure Authentication"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo 'ðŸ” Testing Azure AD federated authentication...'
                az account show
                echo 'âœ… Authentication successful!'
                echo "Branch: $(Build.SourceBranch)"
                echo "Environment: $(targetEnvironment)"
                echo "Image Tag: $(imageTag)"

          - task: AzureCLI@2
            displayName: "Build and Push Images"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "ðŸ—ï¸ Building images for $(targetEnvironment)"
                echo "ðŸ“¦ Image tag: $(imageTag)"

                az acr login --name devopsjourney
                echo "âœ… Logged in to ACR"

                echo "ðŸ”¨ Building backend image..."
                docker build -t $(containerRegistry)/devops-backend:$(imageTag) backend/
                docker push $(containerRegistry)/devops-backend:$(imageTag)
                echo "âœ… Backend image pushed"

                echo "ðŸ”¨ Building frontend image..."
                docker build -t $(containerRegistry)/devops-frontend:$(imageTag) frontend/
                docker push $(containerRegistry)/devops-frontend:$(imageTag)
                echo "âœ… Frontend image pushed"

                echo "ðŸŽ‰ All images built and pushed successfully!"

          - task: AzureCLI@2
            displayName: "Update GitOps Repository"
            inputs:
              azureSubscription: "$(azureServiceConnection)"
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "ðŸ“ Updating GitOps repository for $(targetEnvironment)"
                echo "ðŸŽ¯ Target namespace: $(namespace)"
                echo "ðŸ·ï¸ Image tag: $(imageTag)"

                git config --global user.email "azure-devops@devopsjourney.com"
                git config --global user.name "Azure DevOps Pipeline"

                echo "ðŸ“¥ Cloning repository..."
                git clone $(gitOpsRepoUrl) gitops-working
                cd gitops-working

                if [ "$(targetEnvironment)" = "development" ]; then
                  VALUES_FILE="devops-gitops/helm-charts/devops-app/values.yaml"
                else
                  VALUES_FILE="devops-gitops/helm-charts/devops-app/qa-values.yaml"
                fi

                echo "ðŸ“ Updating values file: $VALUES_FILE"

                if [ ! -f "$VALUES_FILE" ]; then
                  echo "âŒ Values file not found: $VALUES_FILE"
                  ls -la devops-gitops/helm-charts/devops-app/
                  exit 1
                fi

                echo "ðŸ“‹ Current backend/frontend image tags:"
                grep -A 3 "tag:" $VALUES_FILE

                sed -i "s|tag: \"v[0-9]*\"|tag: \"$(imageTag)\"|g" $VALUES_FILE
                sed -i "s|tag: \"dev-[0-9]*\"|tag: \"$(imageTag)\"|g" $VALUES_FILE
                sed -i "s|tag: \"qa-[0-9]*\"|tag: \"$(imageTag)\"|g" $VALUES_FILE

                echo "ðŸ“‹ Updated image tags:"
                grep -A 3 "tag:" $VALUES_FILE

                if git diff --quiet; then
                  echo "â„¹ï¸ No changes detected in values file"
                else
                  echo "ðŸ“¤ Committing changes..."
                  git add $VALUES_FILE

                  cat > commitmsg.txt <<EOF
ðŸš€ Deploy $(targetEnvironment): Update images to $(imageTag)
Environment: $(targetEnvironment)
Namespace: $(namespace)
Backend: $(containerRegistry)/devops-backend:$(imageTag)
Frontend: $(containerRegistry)/devops-frontend:$(imageTag)

Pipeline: $(Build.BuildNumber)
Branch: $(Build.SourceBranch)
EOF

                  git commit -F commitmsg.txt
                  git push origin HEAD
                  echo "âœ… Changes pushed to repository!"
                  echo "ðŸš€ ArgoCD will detect changes and deploy automatically"
                fi

                echo "ðŸŽ‰ GitOps update completed!"
                echo "ðŸ“ Updated file: $VALUES_FILE"
                echo "ðŸ”„ ArgoCD will sync within 3 minutes"
